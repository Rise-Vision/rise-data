<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../rise-logger/rise-logger.html">

<script src="../moment/moment.js"></script>

<!--
`rise-data` is a web component for storing data.

-->
<dom-module id="rise-data">
  <template>
    <rise-logger id="logger"></rise-logger>

    <iron-ajax id="ping"
               url="//localhost:9494"
               handle-as="json"
               on-response="_handlePingResponse"
               on-error="_handlePingError"
               verbose="true">
    </iron-ajax>

    <content></content>
  </template>
</dom-module>

<!-- build:version -->
<script>var dataVersion = "1.0.0";</script>
<!-- endbuild -->

<script>
  (function() {
    /* global Polymer, moment */
    /* jshint newcap: false */

    "use strict";

    var BQ_TABLE_NAME = "component_data_events";

    function supportsLocalStorage() {
      try {
        return "localStorage" in window && window.localStorage !== null;
      } catch (e) {
        return false;
      }
    }

    Polymer({
      is: "rise-data",

      hostAttributes: {
        hidden: true
      },

      properties: {
        /**
         * The optional usage type for Rise Vision logging purposes. Options are "standalone" or "widget"
         */
        usage: {
          type: String,
          value: ""
        }

      },

      _isCacheRunning: false,

      _pingReceived: false,

      _isValidUsage: function(usage) {
        return usage === "standalone" || usage === "widget";
      },

      /**
       * Fires when a response is received from the ping request.
       */
      _handlePingResponse: function(e, resp) {
        this._isCacheRunning = resp.response && resp.response !== "";
        this._pingReceived = true;
      },

      /**
       * Fires when an error is received from the ping request.
       */
      _handlePingError: function() {
        this._isCacheRunning = false;
        this._pingReceived = true;
      },

      /**
       * An instance of the element was inserted into the DOM.
       */
      attached: function() {
        this.$.ping.generateRequest();
      },

      /**
       * Polymer has finished its initialization. This is the entry point.
       */
      ready: function() {
        var params = {
          event: "ready"
        };

        // only include usage_type if it's a valid usage value
        if (this._isValidUsage(this.usage)) {
          params.usage_type = this.usage;
        }

        params.version = dataVersion;

        // log usage
        this.$.logger.log(BQ_TABLE_NAME, params);
      },

      /**
       * Cache the data
       *
       * @param {String} key The key to identify the item of data
       * @param {Object} data The data to cache
       * @param {Boolean} ts Optionally include a timestamp to cache
       */
      saveItem: function(key, data, ts) {
        var cacheObj = {};

        if (this._pingReceived && key && data) {
          if (!this._isCacheRunning) {
            if (supportsLocalStorage()) {
              cacheObj.data = data;

              if (ts) {
                cacheObj.timestamp = moment().format();
              }

              try {
                localStorage.setItem(key, JSON.stringify(cacheObj));
              } catch(e) {
                console.warn(e.message);
              }

            }
          }

          // TODO: handle Rise Cache running
        }
      },

      /**
       * Retrieve the data
       *
       * @param {String} key The key to identify the item of data
       * @return {Object} The cached data.
       */
      getItem: function(key) {
        var data = null;

        if (this._pingReceived && key) {
          if (!this._isCacheRunning) {
            if (supportsLocalStorage()) {
              // retrieve cached data and parse back
              data = JSON.parse(localStorage.getItem(key));
            }
          }

          // TODO: handle Rise Cache running
        }

        return data;

      },

      /**
       * Delete the data
       *
       * @param {String} key The key to identify the item of data
       */
      deleteItem: function(key) {
        if (this._pingReceived && key) {
          if (!this._isCacheRunning) {
            if (supportsLocalStorage()) {
              try {
                localStorage.removeItem(key);
              } catch (ex) {
                console.warn(ex.message);
              }
            }
          }

          // TODO: handle Rise Cache running
        }
      }

    });
  })();
</script>
